


Create table University (
UniversityId       int, 
UniversityName     nvarchar(50),
Address            nvarchar (50),
Constraint university_pk primary key (UniversityId )
);


create table Student(
Student_id    int,
UniversityId  int,
Student_Name  nvarchar(50),
Student_gpa   decimal,
Constraint Student_fk Foreign key (UniversityId) References University(UniversityId)
);


Insert into University values(1, 'University of Georgia', 'Pekini');
Insert into University values(2, 'sample uni1', 'sample address1');
Insert into University values(3, 'sample uni2', 'sample address2');
Insert into University values(4, 'sample uni3', 'sample address3');
Insert into University values(5, 'sample uni4', 'sample address4');



Insert into Student values(1, 5, 'john', 3.75);
Insert into Student values(2, 2, 'jack', 2.75);
Insert into Student values(3, 3, 'Mari', 2.50);
Insert into Student values(4, 4, 'Diana', 1.50);
Insert into Student values(5, 4, 'Tako', 3);
Insert into Student values(6, 4, 'teona', 4);


--4 
Select * from University join Student on University.UniversityId = Student.UniversityId;

--5 
Select University.UniversityName, Student.Student_gpa from Student
join University on University.UniversityId = Student.UniversityId 
group by University.UniversityName,Student.Student_gpa 
Having Avg(Student_gpa) > 3;


-- 6 
-- part1 
select Student.Student_Name from Student
where Student.Student_gpa >(Select AVG(Student.Student_gpa)from Student);

--part2
select  UniversityName, Student.Student_Name from Student 
join University on Student.UniversityId = University.UniversityId
where Student.Student_gpa > (Select AVG(Student_gpa) from Student) 

--7
Create or alter procedure addstudent @student_id int, @university_id int, @student_name nvarchar(50), @Student_gpa decimal
AS 
BEGIN
	Insert into Student values(@student_id,@university_id,  @student_name, @Student_gpa)
END;


EXEC addstudent @student_id = 1902028,  @university_id = 1, @student_name = 'Peyman', @Student_gpa = 2.75



Create or alter procedure addUniversity @University_id int, @University_name nvarchar(50), @Address nvarchar(50)
AS 
BEGIN
	Insert into University values(@university_id,  @University_name, @Address)
END;
EXEC addUniversity @university_id = 7, @University_name = 'ILIAVA University', @Address = 'some address'


--8
Create or alter Function GpaAveragCalculator ()
Returns decimal
As
BEGIN
	Declare @average decimal;
	Select  @average = AVG(Student.Student_gpa) from Student
	return  @average
END;

Select dbo.GpaAveragCalculator() as average

--9
create table UniAverageGpa(
UniversityId int,
University_Name nvarchar(50), 
University_avg_gpa decimal
);

Create or alter Trigger newRecord 
on Student
after Insert 
AS
BEGIN
	Declare @u_id int, @u_name nvarchar(50), @avg_gpa decimal

	Select @u_id = UniversityId from inserted 
	Select @u_name = UniversityName , @avg_gpa = AVG(Student_gpa)  from  University,Student
	where University.Universityid = @u_id group by UniversityName
	if Exists (Select 1 from UniAverageGpa where UniversityId = @u_id)
	Update  UniAverageGpa set University_avg_gpa = @avg_gpa where UniversityId = @u_id
	else insert into UniAverageGpa values (@u_id , @u_name, @avg_gpa)
	
END;

insert into Student values(199923, 7, 'newPeyman', 2)
insert into Student values(189923, 6, 'newPeyman', 3)

select * from University
select * from UniAverageGpa











